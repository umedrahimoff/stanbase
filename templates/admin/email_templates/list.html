{% extends "admin/layout.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Шаблоны писем</h2>
    <a href="{{ url_for('admin_create_email_template') }}" class="btn btn-primary">Создать шаблон</a>
</div>

<form class="row g-3 mb-3" method="get" action="">
    <div class="col-md-4">
        <input type="text" name="q" class="form-control" placeholder="Поиск по названию..." value="{{ q or '' }}">
    </div>
    <div class="col-md-2">
        <select name="status" class="form-select" onchange="this.form.submit()">
            <option value="">Все статусы</option>
            <option value="active" {% if status=='active' %}selected{% endif %}>Активен</option>
            <option value="inactive" {% if status=='inactive' %}selected{% endif %}>Неактивен</option>
        </select>
    </div>
    <div class="col-md-2">
        <select name="per_page" class="form-select" onchange="this.form.submit()">
            {% for n in [10, 20, 50, 100] %}
                <option value="{{ n }}" {% if per_page == n %}selected{% endif %}>Показать {{ n }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-md-2">
        <button type="submit" class="btn btn-outline-primary">Найти</button>
    </div>
    <div class="col-md-2">
        <select name="sort" class="form-select" onchange="this.form.submit()">
            <option value="newest" {% if sort == 'newest' %}selected{% endif %}>По дате (новые)</option>
            <option value="oldest" {% if sort == 'oldest' %}selected{% endif %}>По дате (старые)</option>
            <option value="name_asc" {% if sort == 'name_asc' %}selected{% endif %}>По алфавиту А-Я</option>
            <option value="name_desc" {% if sort == 'name_desc' %}selected{% endif %}>По алфавиту Я-А</option>
        </select>
    </div>
</form>

{% if templates %}
<table class="table table-striped table-hover align-middle bg-white rounded-0 border-0">
    <thead class="table-light">
        <tr>
            <th>ID</th>
            <th>Название</th>
            <th>Код</th>
            <th>Тема</th>
            <th>Статус</th>
            <th>Обновлен</th>
            <th class="text-end">Действия</th>
        </tr>
    </thead>
    <tbody>
        {% for template in templates %}
        <tr>
            <td>{{ template.id }}</td>
            <td>
                <strong>{{ template.name }}</strong>
                {% if template.description %}
                <br><small class="text-muted">{{ template.description }}</small>
                {% endif %}
            </td>
            <td><code>{{ template.code }}</code></td>
            <td>{{ template.subject }}</td>
            <td>
                {% if template.is_active %}
                <span class="badge bg-success">Активен</span>
                {% else %}
                <span class="badge bg-secondary">Неактивен</span>
                {% endif %}
            </td>
            <td>
                <small class="text-muted">
                    {{ template.updated_at.strftime('%d.%m.%Y %H:%M') }}
                    {% if template.updated_by %}
                    <br>от {{ template.updated_by }}
                    {% endif %}
                </small>
            </td>
            <td class="text-end">
                <a href="{{ url_for('admin_edit_email_template', template_id=template.id) }}" class="btn btn-sm btn-outline-secondary" title="Редактировать">
                    <i class="bi bi-pencil"></i>
                </a>
                <a href="{{ url_for('admin_preview_email_template', template_id=template.id) }}" 
                   class="btn btn-sm btn-outline-info" title="Предпросмотр">
                    <i class="bi bi-eye"></i>
                </a>
                <button type="button" class="btn btn-sm btn-outline-success" title="Тестовая отправка"
                        onclick="showTestSendModal({{ template.id }}, '{{ template.name }}')">
                    <i class="bi bi-send"></i>
                </button>
                <form action="{{ url_for('admin_delete_email_template', template_id=template.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Удалить шаблон?');">
                    <button type="submit" class="btn btn-sm btn-outline-danger" title="Удалить">
                        <i class="bi bi-trash"></i>
                    </button>
                </form>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table>

{% set last_page = (total // per_page) + (1 if total % per_page else 0) %}
{% if last_page > 1 %}
<nav>
    <ul class="pagination justify-content-center">
        <li class="page-item {% if page == 1 %}disabled{% endif %}">
            <a class="page-link" href="?q={{ q }}&status={{ status }}&per_page={{ per_page }}&sort={{ sort }}&page={{ page-1 }}">&laquo;</a>
        </li>
        {% for p in range(1, last_page+1) %}
            <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="?q={{ q }}&status={{ status }}&per_page={{ per_page }}&sort={{ sort }}&page={{ p }}">{{ p }}</a></li>
        {% endfor %}
        <li class="page-item {% if page == last_page %}disabled{% endif %}">
            <a class="page-link" href="?q={{ q }}&status={{ status }}&per_page={{ per_page }}&sort={{ sort }}&page={{ page+1 }}">&raquo;</a>
        </li>
    </ul>
</nav>
{% endif %}
{% else %}
<div class="text-center py-4">
    <i class="bi bi-envelope display-1 text-muted"></i>
    <h4 class="mt-3">Шаблоны писем не найдены</h4>
    <p class="text-muted">Создайте первый шаблон письма для начала работы</p>
</div>
{% endif %}

<!-- Модальное окно для тестовой отправки -->
<div class="modal fade" id="testSendModal" tabindex="-1" aria-labelledby="testSendModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="testSendModalLabel">Тестовая отправка</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="testSendForm">
                    <input type="hidden" id="testTemplateId" name="template_id">
                    <div class="mb-3">
                        <label for="testEmail" class="form-label">Email для тестирования</label>
                        <input type="email" class="form-control" id="testEmail" name="test_email" required>
                        <div class="form-text">Введите email для отправки тестового письма</div>
                    </div>
                </form>
                <div id="testSendResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                <button type="button" class="btn btn-primary" onclick="sendTestEmail()">Отправить</button>
            </div>
        </div>
    </div>
</div>

<script>
function showTestSendModal(templateId, templateName) {
    document.getElementById('testTemplateId').value = templateId;
    document.getElementById('testSendModalLabel').textContent = `Тестовая отправка: ${templateName}`;
    document.getElementById('testEmail').value = '';
    document.getElementById('testSendResult').style.display = 'none';
    
    const modal = new bootstrap.Modal(document.getElementById('testSendModal'));
    modal.show();
}

async function sendTestEmail() {
    const form = document.getElementById('testSendForm');
    const formData = new FormData(form);
    const resultDiv = document.getElementById('testSendResult');
    const sendBtn = document.querySelector('#testSendModal .btn-primary');
    
    // Показываем индикатор загрузки
    sendBtn.innerHTML = '<i class="bi bi-hourglass-split me-1"></i>Отправка...';
    sendBtn.disabled = true;
    
    try {
        const response = await fetch(`/admin/email-templates/${formData.get('template_id')}/test-send`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        resultDiv.style.display = 'block';
        if (data.success) {
            resultDiv.className = 'alert alert-success';
            resultDiv.innerHTML = `<i class="bi bi-check-circle me-1"></i>${data.message}`;
        } else {
            resultDiv.className = 'alert alert-danger';
            resultDiv.innerHTML = `<i class="bi bi-exclamation-triangle me-1"></i>${data.error}`;
        }
    } catch (error) {
        resultDiv.style.display = 'block';
        resultDiv.className = 'alert alert-danger';
        resultDiv.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i>Ошибка отправки запроса';
    } finally {
        sendBtn.innerHTML = 'Отправить';
        sendBtn.disabled = false;
    }
}
</script>
{% endblock %} 