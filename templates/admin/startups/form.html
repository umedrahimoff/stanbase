{% extends 'admin/layout.html' %}
{% block content %}
<div class="row justify-content-center g-2">
  <div class="col-lg-9">
    <div class="card mb-3">
      <div class="card-body">
        <h3 class="mb-4">{% if startup %}Редактировать стартап{% else %}Создать стартап{% endif %}</h3>
        <ul class="nav nav-tabs mb-4" id="startupTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="main-tab" data-bs-toggle="tab" data-bs-target="#main" type="button" role="tab">Основная информация</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="team-tab" data-bs-toggle="tab" data-bs-target="#team" type="button" role="tab">Команда</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="deals-tab" data-bs-toggle="tab" data-bs-target="#deals" type="button" role="tab">Раунды</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="jobs-tab" data-bs-toggle="tab" data-bs-target="#jobs" type="button" role="tab">Вакансии</button>
          </li>
        </ul>
        {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}
        <div class="tab-content" id="startupTabContent">
          <div class="tab-pane fade show active" id="main" role="tabpanel">
            <form method="post">
              <div class="mb-3">
                <label class="form-label">Название</label>
                <input type="text" name="name" class="form-control" value="{{ startup.name if startup else '' }}" required>
              </div>
              <div class="mb-3">
                <label class="form-label">Описание</label>
                <textarea name="description" class="form-control">{{ startup.description if startup else '' }}</textarea>
              </div>
              <div class="mb-3">
                <label class="form-label">Страна <span class="text-danger">*</span></label>
                <select name="country" id="country-select" class="form-select" required>
                  <option value=""></option>
                  {% for c in countries %}
                    <option value="{{ c.id }}" {% if startup and startup.country == c.name %}selected{% endif %}>{{ c.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Город <span class="text-danger">*</span></label>
                <select name="city" id="city-select" class="form-select" required>
                  <option value=""></option>
                  {% for city in cities %}
                    <option value="{{ city.id }}" data-country="{{ city.country_id }}" {% if startup and startup.city == city.name %}selected{% endif %}>{{ city.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Стадия <span class="text-danger">*</span></label>
                <select name="stage" class="form-select" required>
                  <option value=""></option>
                  {% for s in stages %}
                    <option value="{{ s.id }}" {% if startup and startup.stage == s.name %}selected{% endif %}>{{ s.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Индустрия <span class="text-danger">*</span></label>
                <select name="industry" class="form-select" required>
                  <option value=""></option>
                  {% for i in industries %}
                    <option value="{{ i.id }}" {% if startup and startup.industry == i.name %}selected{% endif %}>{{ i.name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Статус</label>
                <select name="status" class="form-select" required>
                  <option value="active" {% if startup and startup.status=='active' %}selected{% endif %}>Активен</option>
                  <option value="inactive" {% if startup and startup.status=='inactive' %}selected{% endif %}>Неактивен</option>
                  <option value="archived" {% if startup and startup.status=='archived' %}selected{% endif %}>Архив</option>
                  <option value="draft" {% if startup and startup.status=='draft' %}selected{% endif %}>Черновик</option>
                </select>
              </div>
              <div class="mb-3">
                <label class="form-label">Дата основания (YYYY-MM-DD)</label>
                <input type="text" name="founded_date" class="form-control" value="{{ startup.founded_date if startup and startup.founded_date else '' }}">
              </div>
              <div class="mb-3">
                <label class="form-label">Сайт</label>
                <input type="text" name="website" class="form-control" value="{{ startup.website if startup else '' }}">
              </div>
              <div class="d-flex justify-content-between mt-4">
                <button type="submit" class="btn btn-primary">Сохранить</button>
                <a href="{{ url_for('admin_startups') }}" class="btn btn-link">Отмена</a>
              </div>
            </form>
          </div>
          <div class="tab-pane fade" id="team" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Команда</h5>
              <button class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#addTeamModal">Добавить</button>
            </div>
            <table class="table table-sm table-hover">
              <thead><tr><th>Имя</th><th>Роль</th><th>LinkedIn</th><th></th></tr></thead>
              <tbody>
                {% for p in team %}
                  <tr>
                    <td>{{ p.name }}</td>
                    <td>{{ p.role }}</td>
                    <td>{% if p.linkedin %}<a href="{{ p.linkedin }}" target="_blank">LinkedIn</a>{% endif %}</td>
                    <td class="text-end">
                      <button class="btn btn-sm btn-outline-secondary">Редактировать</button>
                      <button class="btn btn-sm btn-outline-danger">Удалить</button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <!-- Модалка для добавления участника команды -->
          <div class="modal fade" id="addTeamModal" tabindex="-1" aria-labelledby="addTeamModalLabel" aria-hidden="true">
            <div class="modal-dialog">
              <div class="modal-content">
                <form method="post" action="{{ url_for('admin_create_team_member') }}?startup_id={{ startup.id }}">
                  <div class="modal-header">
                    <h5 class="modal-title" id="addTeamModalLabel">Добавить участника команды</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <label class="form-label">Имя <span class="text-danger">*</span></label>
                      <input type="text" name="name" class="form-control" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">Роль <span class="text-danger">*</span></label>
                      <input type="text" name="role" class="form-control" required>
                    </div>
                    <div class="mb-3">
                      <label class="form-label">LinkedIn</label>
                      <input type="text" name="linkedin" class="form-control" placeholder="https://linkedin.com/in/username">
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="submit" class="btn btn-primary">Добавить</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="deals" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Раунды</h5>
              <button class="btn btn-sm btn-outline-primary">Добавить</button>
            </div>
            <table class="table table-sm table-hover">
              <thead><tr><th>Тип</th><th>Сумма</th><th>Оценка</th><th>Дата</th><th>Инвесторы</th><th></th></tr></thead>
              <tbody>
                {% for d in deals %}
                  <tr>
                    <td>{{ d.type }}</td>
                    <td>{{ d.amount }}</td>
                    <td>{{ d.valuation }}</td>
                    <td>{{ d.date }}</td>
                    <td>{{ d.investors }}</td>
                    <td class="text-end">
                      <button class="btn btn-sm btn-outline-secondary">Редактировать</button>
                      <button class="btn btn-sm btn-outline-danger">Удалить</button>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          <div class="tab-pane fade" id="jobs" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">Вакансии</h5>
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin_create_job') }}?startup_id={{ startup.id }}">Добавить</a>
            </div>
            <table class="table table-sm table-hover">
              <thead><tr><th>Должность</th><th>Город</th><th>Тип</th><th>Контакт</th><th></th></tr></thead>
              <tbody>
                {% for j in jobs %}
                  <tr>
                    <td>{{ j.title }}</td>
                    <td>{{ j.city }}</td>
                    <td>{{ j.job_type }}</td>
                    <td>{{ j.contact }}</td>
                    <td class="text-end">
                      <a href="{{ url_for('admin_edit_job', job_id=j.id) }}" class="btn btn-sm btn-outline-secondary">Редактировать</a>
                      <form action="{{ url_for('admin_delete_job', job_id=j.id) }}" method="post" style="display:inline;" onsubmit="return confirm('Удалить вакансию?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger">Удалить</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-lg-3">
    <div class="card mb-3">
      <div class="card-body">
        <h6 class="text-muted mb-3">Техническая информация</h6>
        {% if startup %}
          <div class="mb-2"><b>ID:</b> {{ startup.id }}</div>
          <div class="mb-2"><b>Создано:</b> {{ startup.created_at.strftime('%d.%m.%Y %H:%M') if startup.created_at else '—' }}</div>
          <div class="mb-2"><b>Изменено:</b> {{ startup.updated_at.strftime('%d.%m.%Y %H:%M') if startup.updated_at else '—' }}</div>
          <div class="mb-2"><b>Кто создал:</b> {{ startup.created_by or '—' }}</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(function() {
  // Фильтрация городов по стране
  $('#country-select').on('change', function() {
    var countryId = $(this).val();
    $('#city-select option').each(function() {
      if (!countryId || $(this).val() === "") {
        $(this).show();
      } else if ($(this).data('country') == countryId) {
        $(this).show();
      } else {
        $(this).hide();
      }
    });
    // Сбросить выбранный город, если он не из выбранной страны
    var selectedCity = $('#city-select').val();
    if (selectedCity && $('#city-select option:selected').is(':hidden')) {
      $('#city-select').val('');
    }
  });
  // При загрузке страницы применить фильтр, если страна выбрана
  $('#country-select').trigger('change');
});
</script>
{% endblock %} 