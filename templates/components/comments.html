<!-- Компонент комментариев -->
<div class="comments-section" data-entity-type="{{ entity_type }}" data-entity-id="{{ entity_id }}">
    <h4 class="mb-3">
        Комментарии 
        <span class="badge bg-secondary" id="comments-count">{{ comments|length }}</span>
    </h4>
    
    {% if session.user_id %}
        <!-- Форма добавления комментария -->
        <div class="card mb-4">
            <div class="card-body">
                <form id="comment-form">
                    <input type="hidden" name="entity_type" value="{{ entity_type }}">
                    <input type="hidden" name="entity_id" value="{{ entity_id }}">
                    <div class="mb-3">
                        <textarea class="form-control" name="content" rows="3" 
                                  placeholder="Напишите ваш комментарий..." required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Добавить комментарий</button>
                </form>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info">
            <a href="/login">Войдите</a> чтобы оставить комментарий
        </div>
    {% endif %}
    
    <!-- Список комментариев -->
    <div id="comments-list">
        {% if comments %}
            {% for comment in comments %}
            <div class="card mb-3 comment-item" data-comment-id="{{ comment.id }}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="card-subtitle mb-1">{{ comment.user.first_name }} {{ comment.user.last_name }}</h6>
                        <small class="text-muted">{{ comment.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                    </div>
                    <p class="card-text">{{ comment.content }}</p>
                    
                    <!-- Кнопки действий -->
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-secondary" 
                                onclick="showReplyForm({{ comment.id }})">
                            Ответить
                        </button>
                        {% if session.user_id == comment.user_id or session.role in ['admin', 'moderator'] %}
                        <button class="btn btn-sm btn-outline-danger" 
                                onclick="deleteComment({{ comment.id }})">
                            Удалить
                        </button>
                        {% endif %}
                    </div>
                    
                    <!-- Форма ответа (скрыта) -->
                    <div id="reply-form-{{ comment.id }}" class="mt-3" style="display: none;">
                        <form class="reply-form" data-parent-id="{{ comment.id }}">
                            <input type="hidden" name="entity_type" value="{{ entity_type }}">
                            <input type="hidden" name="entity_id" value="{{ entity_id }}">
                            <input type="hidden" name="parent_id" value="{{ comment.id }}">
                            <div class="mb-2">
                                <textarea class="form-control form-control-sm" name="content" rows="2" 
                                          placeholder="Напишите ответ..." required></textarea>
                            </div>
                            <div class="d-flex gap-2">
                                <button type="submit" class="btn btn-sm btn-primary">Ответить</button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" 
                                        onclick="hideReplyForm({{ comment.id }})">Отмена</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Ответы на комментарий -->
                    <div class="replies mt-3">
                        {% for reply in comment.replies %}
                        <div class="card ms-4 mb-2 reply-item" data-comment-id="{{ reply.id }}">
                            <div class="card-body py-2">
                                <div class="d-flex justify-content-between align-items-start mb-1">
                                    <h6 class="card-subtitle mb-1 small">{{ reply.user.first_name }} {{ reply.user.last_name }}</h6>
                                    <small class="text-muted">{{ reply.created_at.strftime('%d.%m.%Y %H:%M') }}</small>
                                </div>
                                <p class="card-text small mb-1">{{ reply.content }}</p>
                                {% if session.user_id == reply.user_id or session.role in ['admin', 'moderator'] %}
                                <button class="btn btn-sm btn-outline-danger btn-sm" 
                                        onclick="deleteComment({{ reply.id }})">
                                    Удалить
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-4">
                <i class="fas fa-comments fa-2x text-muted mb-2"></i>
                <p class="text-muted">Пока нет комментариев. Будьте первым!</p>
            </div>
        {% endif %}
    </div>
</div>

<script>
// Добавление комментария
document.getElementById('comment-form')?.addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/comments/add', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Очищаем форму
            this.reset();
            
            // Добавляем новый комментарий в список
            const commentsList = document.getElementById('comments-list');
            const newComment = createCommentElement(data.comment);
            commentsList.insertBefore(newComment, commentsList.firstChild);
            
            // Обновляем счетчик
            updateCommentsCount();
        } else {
            alert('Ошибка: ' + data.error);
        }
    });
});

// Добавление ответа
document.addEventListener('submit', function(e) {
    if (e.target.classList.contains('reply-form')) {
        e.preventDefault();
        
        const formData = new FormData(e.target);
        const parentId = e.target.dataset.parentId;
        
        fetch('/comments/add', {
            method: 'POST',
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Очищаем форму и скрываем её
                e.target.reset();
                hideReplyForm(parentId);
                
                // Добавляем новый ответ
                const replyElement = createReplyElement(data.comment);
                const parentComment = document.querySelector(`[data-comment-id="${parentId}"]`);
                const repliesContainer = parentComment.querySelector('.replies');
                repliesContainer.appendChild(replyElement);
                
                // Обновляем счетчик
                updateCommentsCount();
            } else {
                alert('Ошибка: ' + data.error);
            }
        });
    }
});

function showReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).style.display = 'block';
}

function hideReplyForm(commentId) {
    document.getElementById(`reply-form-${commentId}`).style.display = 'none';
}

function deleteComment(commentId) {
    if (confirm('Вы уверены, что хотите удалить этот комментарий?')) {
        fetch(`/comments/${commentId}/delete`, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const commentElement = document.querySelector(`[data-comment-id="${commentId}"]`);
                commentElement.remove();
                updateCommentsCount();
            } else {
                alert('Ошибка: ' + data.error);
            }
        });
    }
}

function createCommentElement(comment) {
    const div = document.createElement('div');
    div.className = 'card mb-3 comment-item';
    div.dataset.commentId = comment.id;
    
    div.innerHTML = `
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <h6 class="card-subtitle mb-1">${comment.user_name}</h6>
                <small class="text-muted">${comment.created_at}</small>
            </div>
            <p class="card-text">${comment.content}</p>
            <div class="d-flex gap-2">
                <button class="btn btn-sm btn-outline-secondary" onclick="showReplyForm(${comment.id})">
                    Ответить
                </button>
            </div>
            <div id="reply-form-${comment.id}" class="mt-3" style="display: none;">
                <form class="reply-form" data-parent-id="${comment.id}">
                    <input type="hidden" name="entity_type" value="${document.querySelector('.comments-section').dataset.entityType}">
                    <input type="hidden" name="entity_id" value="${document.querySelector('.comments-section').dataset.entityId}">
                    <input type="hidden" name="parent_id" value="${comment.id}">
                    <div class="mb-2">
                        <textarea class="form-control form-control-sm" name="content" rows="2" placeholder="Напишите ответ..." required></textarea>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-sm btn-primary">Ответить</button>
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="hideReplyForm(${comment.id})">Отмена</button>
                    </div>
                </form>
            </div>
            <div class="replies mt-3"></div>
        </div>
    `;
    
    return div;
}

function createReplyElement(reply) {
    const div = document.createElement('div');
    div.className = 'card ms-4 mb-2 reply-item';
    div.dataset.commentId = reply.id;
    
    div.innerHTML = `
        <div class="card-body py-2">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <h6 class="card-subtitle mb-1 small">${reply.user_name}</h6>
                <small class="text-muted">${reply.created_at}</small>
            </div>
            <p class="card-text small mb-1">${reply.content}</p>
        </div>
    `;
    
    return div;
}

function updateCommentsCount() {
    const count = document.querySelectorAll('.comment-item').length;
    document.getElementById('comments-count').textContent = count;
}
</script>

<style>
.comment-item {
    border-left: 3px solid #007bff;
}

.reply-item {
    border-left: 2px solid #6c757d;
    background-color: #f8f9fa;
}

.comments-section {
    margin-top: 2rem;
    padding-top: 2rem;
    border-top: 1px solid #dee2e6;
}
</style> 