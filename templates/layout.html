<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Stanbase{% endblock %}</title>
    
    <!-- SEO Meta Tags -->
    <meta name="description" content="{% block meta_description %}Stanbase - ведущая платформа для компаний и инвесторов Центральной Азии. Найдите инновационные проекты, инвесторов и актуальные новости экосистемы региона.{% endblock %}">
    <meta name="keywords" content="{% block meta_keywords %}компании, инвесторы, Центральная Азия, венчурные инвестиции, инновации, технологические проекты, Казахстан, Узбекистан, Кыргызстан, Таджикистан, Туркменистан{% endblock %}">
    <meta name="author" content="Stanbase">
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="{% block og_title %}{% endblock %}">
    <meta property="og:description" content="{% block og_description %}{% endblock %}">
    <meta property="og:type" content="website">
    <meta property="og:url" content="{{ request.url }}">
    <meta property="og:site_name" content="Stanbase">
    
    <!-- Twitter Card Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="{% block twitter_title %}{% endblock %}">
    <meta name="twitter:description" content="{% block twitter_description %}{% endblock %}">
    
    <!-- Additional Meta Tags -->
    <meta name="language" content="ru">
    <meta name="geo.region" content="KZ,UZ,KG,TJ,TM">
    <meta name="geo.placename" content="Центральная Азия">
    <link rel="canonical" href="{{ request.url }}">
    <link rel="icon" type="image/svg+xml" href="https://api.dicebear.com/7.x/bottts/svg?seed=stanbase" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
    <style>
      body { background: #fff; font-family: 'Roboto', Arial, sans-serif; }
      .card { border-radius: 12px; box-shadow: 0 1px 4px rgba(0,0,0,0.04); }
      .navbar { margin-bottom: 2rem; }
      .card-title a, .card-body a {
        color: inherit !important;
        text-decoration: none !important;
      }
      .card-title a:hover, .card-body a:hover {
        color: inherit !important;
        text-decoration: none !important;
      }
    </style>
    {% block head %}{% endblock %}
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-light bg-white border-bottom">
      <div class="container">
        <a class="navbar-brand fw-bold" href="/">Stanbase</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNavbar" aria-controls="mainNavbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="mainNavbar">
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="/companies">Компании</a></li>
            <li class="nav-item"><a class="nav-link" href="/investors">Инвесторы</a></li>
            <li class="nav-item"><a class="nav-link" href="/news">Новости</a></li>
            <li class="nav-item"><a class="nav-link" href="/events">Мероприятия</a></li>
            <!-- Кнопка Войти/Добавить запись -->
            {% if session is defined and session.get('user_id') %}
            <li class="nav-item dropdown d-flex align-items-center">
              <a href="#" class="nav-link dropdown-toggle d-flex align-items-center" id="userDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                <img src="https://api.dicebear.com/7.x/identicon/svg?seed={{ session.get('user_email', 'user') }}" alt="avatar" width="32" height="32" class="rounded-circle me-2"/>
                <span class="d-none d-md-inline">{{ session.get('user_name', 'Пользователь') }}</span>
              </a>
              <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
                <li><a class="dropdown-item" href="/logout">Выйти</a></li>
              </ul>
            </li>
            {% else %}
            <li class="nav-item d-flex align-items-center">
              <button class="btn btn-outline-primary ms-lg-3" data-bs-toggle="modal" data-bs-target="#loginModal">Войти</button>
            </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      {% if session.get('flash') %}
        <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
          {{ session.get('flash') }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        {% set _ = session.pop('flash') %}
      {% endif %}
      {% block content %}{% endblock %}
      <div style="margin-bottom: 48px;"></div>
    </div>

    <!-- Login Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" aria-labelledby="loginModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="loginModalLabel">Вход</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="loginForm" method="post" action="/login">
              <div class="mb-3">
                <label for="login-email" class="form-label">Email</label>
                <input type="email" class="form-control" id="login-email" name="email" required autofocus>
              </div>
              <div class="mb-3">
                <label for="login-password" class="form-label">Пароль</label>
                <input type="password" class="form-control" id="login-password" name="password" required>
              </div>
              <button type="submit" class="btn btn-primary w-100">Войти</button>
            </form>
            <div class="mt-3 text-center">
              <a href="/register" id="showRegisterPage">Нет аккаунта? Зарегистрироваться</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <script>
      document.addEventListener('DOMContentLoaded', function() {
        var showRegister = document.getElementById('showRegisterModal');
        var showLogin = document.getElementById('showLoginModal');
        if (showRegister) {
          showRegister.addEventListener('click', function(e) {
            e.preventDefault();
            var loginModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal'));
            var registerModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('registerModal'));
            loginModal.hide();
            setTimeout(function() { registerModal.show(); }, 300);
          });
        }
        if (showLogin) {
          showLogin.addEventListener('click', function(e) {
            e.preventDefault();
            var registerModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('registerModal'));
            var loginModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal'));
            registerModal.hide();
            setTimeout(function() { loginModal.show(); }, 300);
          });
        }

        // AJAX логин
        var loginForm = document.getElementById('loginForm');
        if (loginForm) {
          loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Отправка формы логина');
            var formData = new FormData(loginForm);
            var resp = await fetch('/login', {
              method: 'POST',
              body: formData,
              headers: { 'X-Requested-With': 'XMLHttpRequest' },
              credentials: 'same-origin'
            });
            var data = await resp.json();
            if (data.success) {
              window.location.reload();
            } else {
              var alert = loginForm.querySelector('.alert');
              if (!alert) {
                alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                loginForm.prepend(alert);
              }
              alert.textContent = data.error || 'Ошибка входа';
            }
          });
        }
        // AJAX регистрация
        var registerForm = document.getElementById('registerForm');
        if (registerForm) {
          registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            console.log('Отправка формы регистрации');
            var formData = new FormData(registerForm);
            var resp = await fetch('/register', {
              method: 'POST',
              body: formData,
              headers: { 'X-Requested-With': 'XMLHttpRequest', 'Accept': 'application/json' },
              credentials: 'same-origin'
            });
            var data;
            try {
              data = await resp.json();
            } catch (err) {
              var alert = registerForm.querySelector('.alert');
              if (!alert) {
                alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                registerForm.prepend(alert);
              }
              alert.textContent = 'Ошибка регистрации: некорректный ответ сервера.';
              return;
            }
            if (data.success) {
              window.location.reload();
            } else {
              var alert = registerForm.querySelector('.alert');
              if (!alert) {
                alert = document.createElement('div');
                alert.className = 'alert alert-danger';
                registerForm.prepend(alert);
              }
              alert.textContent = data.error || 'Ошибка регистрации';
            }
          });
        }
        // Открытие модалки логина по кнопке/ссылке с классом .open-login-modal
        document.querySelectorAll('.open-login-modal').forEach(function(btn) {
          btn.addEventListener('click', function(e) {
            e.preventDefault();
            var loginModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('loginModal'));
            loginModal.show();
          });
        });
      });
    </script>
    <footer class="footer mt-auto py-3 bg-light border-top">
      <div class="container text-center small text-muted">
        Stanbase &copy; 2025 &middot; Powered by Venn Lab
      </div>
    </footer>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    {% block scripts %}{% endblock %}
  </body>
</html> 