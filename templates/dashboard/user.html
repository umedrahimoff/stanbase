{% extends 'layout.html' %}
{% block title %}Личный кабинет — stanbase{% endblock %}
{% block content %}
<style>
  /* Убираем отступ сверху для ЛК */
  body {
    padding-top: 0 !important;
  }
  
  .dashboard-sidebar {
    background: #f8f9fa;
    border-right: 1px solid #dee2e6;
    min-height: calc(100vh - 100px);
  }
  .dashboard-sidebar .nav-link {
    color: #495057;
    border-radius: 6px;
    margin-bottom: 2px;
    padding: 10px 16px;
    font-size: 0.95rem;
  }
  .dashboard-sidebar .nav-link:hover {
    background: #e9ecef;
    color: #212529;
  }
  .dashboard-sidebar .nav-link.active {
    background: #0d6efd;
    color: white !important;
  }
  .dashboard-sidebar .nav-link.active i {
    color: white !important;
  }
  .dashboard-content {
    padding: 20px;
  }
  .stats-card {
    background: #fff;
    border: 1px solid #dee2e6;
    border-radius: 8px;
  }
  .stats-card .card-body {
    padding: 16px;
  }
  .profile-section {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 8px;
  }
  .action-card {
    border: 1px solid #dee2e6;
    border-radius: 8px;
  }
  .action-card:hover {
    border-color: #0d6efd;
  }
  
  /* Белый текст для кнопок в модальном окне */
  .modal .btn-primary,
  .modal .btn-success {
    color: white !important;
  }
  
  /* Скрытие вкладок по умолчанию */
  .tab-pane {
    display: none;
  }
  
  .tab-pane.show.active {
    display: block;
  }
  
  /* Предотвращение наложения содержимого */
  .tab-content {
    position: relative;
  }
</style>

<div class="container-fluid">
  <div class="row">
    <!-- Сайдбар -->
    <div class="col-md-4 col-lg-3 dashboard-sidebar">
      <div class="p-3">
        <h5 class="mb-3">Личный кабинет</h5>
                        <nav class="nav flex-column">
                  <a class="nav-link active" href="#profile">
                    <i class="bi bi-person me-2"></i>Профиль
                  </a>
                  <a class="nav-link" href="#pages">
                    <i class="bi bi-building me-2"></i>Моя компания
                  </a>
                  {% if user.company_id %}
                  <a class="nav-link" href="#edit-company">
                    <i class="bi bi-pencil-square me-2"></i>Редактировать компанию
                  </a>
                  {% endif %}
                </nav>
      </div>
    </div>

    <!-- Основной контент -->
    <div class="col-md-8 col-lg-9 dashboard-content">
      <!-- Уведомления -->
              <!-- Toast Container -->
        <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1050;">
          <!-- Error Toast -->
          {% if error %}
            <div class="toast align-items-center text-white bg-danger border-0" id="errorToast" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  <i class="bi bi-exclamation-triangle me-2"></i>
                  {% if error == 'already_has_company' %}
                    У вас уже есть профиль компании. Один пользователь может создать только одну компанию.
                  {% elif error == 'already_has_investor' %}
                    У вас уже есть профиль инвестора. Один пользователь может создать только один профиль инвестора.
                  {% elif error == 'creation_failed' %}
                    Произошла ошибка при создании профиля. Попробуйте еще раз.
                  {% elif error == 'no_company' %}
                    У вас нет профиля компании для редактирования.
                  {% elif error == 'company_not_found' %}
                    Профиль компании не найден.
                  {% elif error == 'edit_failed' %}
                    Произошла ошибка при редактировании компании.
                  {% elif error == 'invalid_current_password' %}
                    Неверный текущий пароль.
                  {% elif error == 'passwords_dont_match' %}
                    Новые пароли не совпадают.
                  {% elif error == 'password_too_short' %}
                    Новый пароль должен содержать минимум 6 символов.
                  {% elif error == 'password_change_failed' %}
                    Ошибка при изменении пароля. Попробуйте еще раз.
                  {% else %}
                    {{ error }}
                  {% endif %}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          {% endif %}

          <!-- Success Toast -->
          {% if success %}
            <div class="toast align-items-center text-white bg-success border-0" id="successToast" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  <i class="bi bi-check-circle me-2"></i>
                  {% if success == 'company_created' %}
                    Профиль компании успешно создан!
                  {% elif success == 'investor_created' %}
                    Профиль инвестора успешно создан!
                  {% elif success == 'company_updated' %}
                    Профиль компании успешно обновлен!
                  {% elif success == 'profile_updated' %}
                    Профиль успешно обновлен!
                  {% elif success == 'password_changed' %}
                    Пароль успешно изменен!
                  {% elif success == 'team_member_added' %}
                    Новый участник команды успешно добавлен!
                  {% elif success == 'team_member_updated' %}
                    Данные участника команды успешно обновлены!
                  {% elif success == 'team_member_deleted' %}
                    Участник команды успешно удален!
                  {% elif success == 'pitch_added' %}
                    Питч успешно добавлен!
                  {% elif success == 'pitch_updated' %}
                    Питч успешно обновлен!
                  {% elif success == 'pitch_deleted' %}
                    Питч успешно удален!
                  {% else %}
                    {{ success }}
                  {% endif %}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          {% endif %}
        </div>
      
      <div class="tab-content">
        <!-- Вкладка Профиль -->
        <div class="tab-pane fade show active" id="profile">
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Мой профиль</h3>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#editProfileModal">
              <i class="bi bi-pencil me-2"></i>Редактировать профиль
            </button>
          </div>

          <!-- Статистика -->
          <div class="row mb-4">
            <div class="col-md-4">
              <div class="card stats-card">
                <div class="card-body">
                  <div class="text-muted small">Дата регистрации</div>
                  <div class="fw-bold">{{ user.created_at.strftime('%d.%m.%Y') if user.created_at else 'Н/Д' }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card stats-card">
                <div class="card-body">
                  <div class="text-muted small">Тип пользователя</div>
                  <div class="fw-bold">{{ user.role|title }}</div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card stats-card">
                <div class="card-body">
                  <div class="text-muted small">Страна</div>
                  <div class="fw-bold">{{ user.country.name if user.country else 'Н/Д' }}</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Информация профиля -->
          <div class="row">
            <div class="col-md-8">
              <div class="profile-section p-4">
                <h5 class="mb-3">Личная информация</h5>
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Имя</label>
                    <p class="mb-0 fw-bold">{{ user.first_name }}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Фамилия</label>
                    <p class="mb-0 fw-bold">{{ user.last_name }}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Email</label>
                    <p class="mb-0 fw-bold">{{ user.email }}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Телефон</label>
                    <p class="mb-0 fw-bold">{{ user.phone }}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Город</label>
                    <p class="mb-0 fw-bold">{{ user.city }}</p>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label text-muted">Telegram</label>
                    <p class="mb-0 fw-bold">
                      {% if user.telegram %}
                        {% if user.telegram.startswith('http') %}
                          <a href="{{ user.telegram }}" target="_blank" class="text-decoration-none">
                            <i class="bi bi-telegram text-primary me-1"></i>{{ user.telegram.split('/')[-1] or user.telegram.split('@')[-1] or user.telegram }}
                          </a>
                        {% elif user.telegram.startswith('@') %}
                          <a href="https://t.me/{{ user.telegram[1:] }}" target="_blank" class="text-decoration-none">
                            <i class="bi bi-telegram text-primary me-1"></i>{{ user.telegram }}
                          </a>
                        {% else %}
                          <a href="https://t.me/{{ user.telegram }}" target="_blank" class="text-decoration-none">
                            <i class="bi bi-telegram text-primary me-1"></i>@{{ user.telegram }}
                          </a>
                        {% endif %}
                      {% else %}
                        Не указан
                      {% endif %}
                    </p>
                  </div>
                  <div class="col-12 mb-3">
                    <label class="form-label text-muted">LinkedIn</label>
                    <p class="mb-0 fw-bold">
                      {% if user.linkedin %}
                        {% if user.linkedin.startswith('http') %}
                          <a href="{{ user.linkedin }}" target="_blank" class="text-decoration-none">
                            <i class="bi bi-linkedin text-primary me-1"></i>{{ user.linkedin.split('/')[-1] or user.linkedin.split('in/')[-1] or user.linkedin }}
                          </a>
                        {% else %}
                          <a href="https://linkedin.com/in/{{ user.linkedin }}" target="_blank" class="text-decoration-none">
                            <i class="bi bi-linkedin text-primary me-1"></i>{{ user.linkedin }}
                          </a>
                        {% endif %}
                      {% else %}
                        Не указан
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="profile-section p-3">
                <h6 class="mb-3">Быстрые действия</h6>
                <div class="d-grid gap-2">
                  {% if not user.company_id %}
                    <button class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#createPageModal">
                      <i class="bi bi-plus-circle me-2"></i>Создать компанию
                    </button>
                  {% else %}
                    <div class="text-center">
                      <i class="bi bi-building text-success fs-4 mb-2"></i>
                      <p class="text-muted small mb-2">У вас есть компания</p>
                      <a href="#pages" class="btn btn-outline-success btn-sm" onclick="switchToTab('pages')">
                        <i class="bi bi-eye me-2"></i>Просмотреть
                      </a>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>

                        <!-- Вкладка Моя компания -->
                <div class="tab-pane fade" id="pages">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>Моя компания</h3>
                    {% if user.company_id %}
                      <div class="d-flex gap-2">
                        <a href="/company/{{ company.id }}" class="btn btn-outline-primary" target="_blank">
                          <i class="bi bi-box-arrow-up-right me-2"></i>Перейти на сайт
                        </a>
                        <button class="btn btn-primary" onclick="switchToTab('edit-company')">
                          <i class="bi bi-pencil me-2"></i>Редактировать
                        </button>
                      </div>
                    {% else %}
                      <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createPageModal">
                        <i class="bi bi-plus-circle me-2"></i>Создать компанию
                      </button>
                    {% endif %}
                  </div>

                  {% if user.company_id %}
                    <!-- Если компания создана - показываем её информацию -->
                    <div class="company-profile-section">
                      <div class="row">
                        <!-- Основная информация о компании -->
                        <div class="col-md-8">
                          <div class="card mb-4">
                            <div class="card-body">
                              <div class="d-flex align-items-center mb-3">
                                {% if company.logo %}
                                  <img src="{{ company.logo }}" alt="Логотип" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px;">
                                {% else %}
                                  <div class="me-3 bg-light rounded d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                    <i class="bi bi-building text-muted fs-4"></i>
                                  </div>
                                {% endif %}
                                <div>
                                  <h4 class="mb-1">{{ company.name }}</h4>
                                  <p class="text-muted mb-0">
                                    {% if company.city %}{{ company.city }}{% endif %}
                                    {% if company.country %}, {{ company.country }}{% endif %}
                                    {% if company.stage %} • {{ company.stage }}{% endif %}
                                  </p>
                                </div>
                              </div>
                              
                              {% if company.description %}
                                <div class="mb-3">{{ company.description|replace('\n', '<br>')|safe }}</div>
                              {% endif %}
                              
                              <div class="row text-center mb-3">
                                <div class="col-6">
                                  <div class="border-end">
                                    <div class="fw-bold text-primary">{{ company.team|length if company.team else 0 }}</div>
                                    <small class="text-muted">Команда</small>
                                  </div>
                                </div>
                                <div class="col-6">
                                  <div>
                                    <div class="fw-bold text-info">{{ company.pitches|length if company.pitches else 0 }}</div>
                                    <small class="text-muted">Питчи</small>
                                  </div>
                                </div>
                              </div>
                              
                              <div class="text-center">
                                <a href="/company/{{ company.id }}" class="btn btn-outline-primary btn-sm" target="_blank">
                                  <i class="bi bi-box-arrow-up-right me-2"></i>Посмотреть публичную страницу
                                </a>
                              </div>
                            </div>
                          </div>

                          <!-- Команда -->
                          {% if company.team %}
                          <div class="card mb-4">
                            <div class="card-header">
                              <h6 class="mb-0">
                                <i class="bi bi-people me-2"></i>Команда ({{ company.team|length }})
                              </h6>
                            </div>
                            <div class="card-body">
                              <div class="row">
                                {% for person in company.team[:3] %}
                                <div class="col-md-4 mb-3">
                                  <div class="d-flex align-items-center">
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                      <i class="bi bi-person text-muted"></i>
                                    </div>
                                    <div>
                                      <div class="fw-bold">{{ person.name }}</div>
                                      <small class="text-muted">{{ person.role }}</small>
                                    </div>
                                  </div>
                                </div>
                                {% endfor %}
                              </div>
                              {% if company.team|length > 3 %}
                                <div class="text-center mt-2">
                                  <small class="text-muted">И еще {{ company.team|length - 3 }} участников</small>
                                </div>
                              {% endif %}
                            </div>
                          </div>
                          {% endif %}

                        </div>

                        <!-- Боковая панель -->
                        <div class="col-md-4">
                          <div class="card mb-4">
                            <div class="card-header">
                              <h6 class="mb-0">Действия</h6>
                            </div>
                            <div class="card-body">
                              <div class="d-grid gap-2">
                                <a href="/company/{{ user.company_id }}" class="btn btn-outline-primary" target="_blank">
                                  <i class="bi bi-box-arrow-up-right me-2"></i>Открыть на сайте
                                </a>
                                <button class="btn btn-outline-secondary" onclick="switchToTab('edit-company')">
                                  <i class="bi bi-pencil me-2"></i>Редактировать
                                </button>
                              </div>
                            </div>
                          </div>

                          <!-- Дополнительная информация -->
                          <div class="card">
                            <div class="card-header">
                              <h6 class="mb-0">Информация</h6>
                            </div>
                            <div class="card-body">
                              <div class="mb-2">
                                <small class="text-muted">Статус</small>
                                <div class="fw-bold">
                                  <span class="badge bg-{{ 'success' if company.status == 'active' else 'secondary' }}">
                                    {{ company.status }}
                                  </span>
                                </div>
                              </div>
                              {% if company.industry %}
                              <div class="mb-2">
                                <small class="text-muted">Индустрия</small>
                                <div class="fw-bold">{{ company.industry }}</div>
                              </div>
                              {% endif %}
                              {% if company.founded_date %}
                              <div class="mb-2">
                                <small class="text-muted">Основана</small>
                                <div class="fw-bold">{{ company.founded_date.strftime('%d.%m.%Y') }}</div>
                              </div>
                              {% endif %}
                              {% if company.website %}
                              <div class="mb-2">
                                <small class="text-muted">Сайт</small>
                                <div>
                                  <a href="{{ company.website }}" target="_blank" class="text-decoration-none">
                                    {{ company.website }}
                                  </a>
                                </div>
                              </div>
                              {% endif %}
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% else %}
                    <!-- Если компания не создана - показываем призыв к созданию -->
                    <div class="text-center py-5">
                      <i class="bi bi-building text-muted fs-1 mb-3"></i>
                      <h4 class="text-muted">У вас пока нет компании</h4>
                      <p class="text-muted mb-4">Создайте страницу своей компании, чтобы привлечь инвесторов и партнеров</p>
                      <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#createPageModal">
                        <i class="bi bi-plus-circle me-2"></i>Создать компанию
                      </button>
                    </div>
                  {% endif %}
                </div>

                <!-- Вкладка Редактирование компании -->
                {% if user.company_id %}
                <div class="tab-pane fade" id="edit-company">
                  <div class="d-flex justify-content-between align-items-center mb-4">
                    <h3>
                      <i class="bi bi-pencil-square text-primary me-2"></i>
                      Редактировать компанию
                    </h3>
                  </div>

                  <!-- Навигация по вкладкам редактирования -->
                  <ul class="nav nav-tabs mb-4" id="editCompanyTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                      <button class="nav-link active" id="company-info-tab" data-bs-target="#company-info" type="button" role="tab" aria-controls="company-info" aria-selected="true">
                        <i class="bi bi-building me-2"></i>Информация о компании
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="team-tab" data-bs-target="#team" type="button" role="tab" aria-controls="team" aria-selected="false">
                        <i class="bi bi-people me-2"></i>Команда
                      </button>
                    </li>
                    <li class="nav-item" role="presentation">
                      <button class="nav-link" id="pitches-tab" data-bs-target="#pitches" type="button" role="tab" aria-controls="pitches" aria-selected="false">
                        <i class="bi bi-file-earmark-text me-2"></i>Питчи
                      </button>
                    </li>
                  </ul>

                  <!-- Содержимое вкладок -->
                  <div class="tab-content" id="editCompanyTabContent">
                    <!-- Вкладка Информация о компании -->
                    <div class="tab-pane fade show active" id="company-info" role="tabpanel" aria-labelledby="company-info-tab">
                      <form method="post" action="/dashboard/company/edit" enctype="multipart/form-data">
                        <input type="hidden" name="active_tab" value="company-info">
                        <div class="row">
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Название компании *</label>
                            <input type="text" class="form-control" name="name" value="{{ company.name }}" required>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Страна *</label>
                            <select name="country" class="form-select" required>
                              <option value="">Выберите страну</option>
                              {% for country in countries %}
                                <option value="{{ country.name }}" {% if country.name == company.country %}selected{% endif %}>
                                  {{ country.name }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Город *</label>
                            <input type="text" class="form-control" name="city" value="{{ company.city }}" required>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Стадия развития</label>
                            <select name="stage" class="form-select">
                              <option value="">Выберите стадию</option>
                              {% for stage in stages %}
                                <option value="{{ stage.name }}" {% if stage.name == company.stage %}selected{% endif %}>
                                  {{ stage.name }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Индустрия</label>
                            <select name="industry" class="form-select">
                              <option value="">Выберите индустрию</option>
                              {% for category in categories %}
                                <option value="{{ category.name }}" {% if category.name == company.industry %}selected{% endif %}>
                                  {{ category.name }}
                                </option>
                              {% endfor %}
                            </select>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Дата основания</label>
                            <input type="date" class="form-control" name="founded_date" value="{{ company.founded_date.strftime('%Y-%m-%d') if company.founded_date else '' }}">
                          </div>
                          <div class="col-12 mb-3">
                            <label class="form-label">Описание</label>
                            <textarea class="form-control" name="description" rows="4" placeholder="Опишите вашу компанию, продукт или услугу">{{ company.description or '' }}</textarea>
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Веб-сайт</label>
                            <input type="url" class="form-control" name="website" value="{{ company.website or '' }}" placeholder="https://example.com">
                          </div>
                          <div class="col-md-6 mb-3">
                            <label class="form-label">Логотип</label>
                            <input type="file" class="form-control" name="logo" accept="image/*">
                            {% if company.logo %}
                              <small class="text-muted">Текущий логотип: {{ company.logo.split('/')[-1] }}</small>
                            {% endif %}
                          </div>
                        </div>
                        <div class="text-end">
                          <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-circle me-2"></i>Сохранить изменения
                          </button>
                        </div>
                      </form>
                    </div>

                    <!-- Вкладка Команда -->
                    <div class="tab-pane fade" id="team" role="tabpanel" aria-labelledby="team-tab">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Команда компании</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addTeamMemberModal">
                          <i class="bi bi-plus-circle me-2"></i>Добавить участника
                        </button>
                      </div>

                      {% if company.team %}
                        <div class="row">
                          {% for person in company.team %}
                          <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card">
                              <div class="card-body">
                                <div class="d-flex align-items-center mb-2">
                                  <div class="bg-light rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">
                                    <i class="bi bi-person text-muted"></i>
                                  </div>
                                  <div class="flex-grow-1">
                                    <h6 class="mb-1">{{ person.name }}</h6>
                                    <small class="text-muted">{{ person.role }}</small>
                                  </div>
                                </div>
                                {% if person.linkedin or person.telegram or person.instagram or person.website %}
                                  <div class="mb-2">
                                    {% if person.linkedin %}
                                      <a href="{{ person.linkedin }}" target="_blank" class="btn btn-sm btn-outline-primary me-1">
                                        <i class="bi bi-linkedin"></i>
                                      </a>
                                    {% endif %}
                                    {% if person.telegram %}
                                      <a href="https://t.me/{{ person.telegram.replace('@', '') }}" target="_blank" class="btn btn-sm btn-outline-info me-1">
                                        <i class="bi bi-telegram"></i>
                                      </a>
                                    {% endif %}
                                    {% if person.instagram %}
                                      <a href="https://instagram.com/{{ person.instagram.replace('@', '') }}" target="_blank" class="btn btn-sm btn-outline-danger me-1">
                                        <i class="bi bi-instagram"></i>
                                      </a>
                                    {% endif %}
                                    {% if person.website %}
                                      <a href="{{ person.website }}" target="_blank" class="btn btn-sm btn-outline-secondary">
                                        <i class="bi bi-globe"></i>
                                      </a>
                                    {% endif %}
                                  </div>
                                {% endif %}
                                <div class="d-flex gap-1">
                                  <button class="btn btn-sm btn-outline-secondary me-1" onclick="editTeamMember({{ person.id }}, '{{ person.name|e }}', '{{ person.role|e }}', '{{ person.linkedin or ''|e }}', '{{ person.telegram or ''|e }}', '{{ person.instagram or ''|e }}', '{{ person.website or ''|e }}')" title="Редактировать">
                                    <i class="bi bi-pencil"></i>
                                  </button>
                                  <button class="btn btn-sm btn-outline-danger" onclick="deleteTeamMember({{ person.id }}, '{{ person.name|e }}')" title="Удалить">
                                    <i class="bi bi-trash"></i>
                                  </button>
                                </div>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      {% else %}
                        <div class="text-center py-4">
                          <i class="bi bi-people text-muted fs-1 mb-3"></i>
                          <h5 class="text-muted">Команда пока не добавлена</h5>
                          <p class="text-muted mb-3">Добавьте участников команды, чтобы показать структуру вашей компании</p>
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addTeamMemberModal">
                            <i class="bi bi-plus-circle me-2"></i>Добавить первого участника
                          </button>
                        </div>
                      {% endif %}
                    </div>

                    <!-- Вкладка Питчи -->
                    <div class="tab-pane fade" id="pitches" role="tabpanel" aria-labelledby="pitches-tab">
                      <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5>Питч-деки</h5>
                        <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addPitchModal">
                          <i class="bi bi-plus-circle me-2"></i>Добавить питч
                        </button>
                      </div>

                      {% if company.pitches %}
                        <div class="row">
                          {% for pitch in company.pitches %}
                          <div class="col-md-6 mb-3">
                            <div class="card">
                              <div class="card-body">
                                <h6 class="mb-2">{{ pitch.name or 'Питч-дек' }}</h6>
                                <div class="d-flex justify-content-between align-items-center">
                                  <small class="text-muted">
                                    {% if pitch.created_at %}{{ pitch.created_at.strftime('%d.%m.%Y') }}{% endif %}
                                  </small>
                                  <div class="d-flex gap-1">
                                    {% if pitch.url %}
                                      <a href="{{ pitch.url }}" target="_blank" class="btn btn-sm btn-outline-primary" title="Открыть питч">
                                        <i class="bi bi-box-arrow-up-right"></i>
                                      </a>
                                    {% endif %}
                                    <button class="btn btn-sm btn-outline-secondary me-1" onclick="editPitch({{ pitch.id }})" title="Редактировать">
                                      <i class="bi bi-pencil"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePitch({{ pitch.id }})" title="Удалить">
                                      <i class="bi bi-trash"></i>
                                    </button>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                          {% endfor %}
                        </div>
                      {% else %}
                        <div class="text-center py-4">
                          <i class="bi bi-file-earmark-text text-muted fs-1 mb-3"></i>
                          <h5 class="text-muted">Питч-деки пока не добавлены</h5>
                          <p class="text-muted mb-3">Добавьте питч-деки, чтобы показать презентации вашего проекта</p>
                          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addPitchModal">
                            <i class="bi bi-plus-circle me-2"></i>Добавить первый питч
                          </button>
                        </div>
                      {% endif %}
                    </div>
                  </div>
                </div>
                {% endif %}






      </div>
    </div>
  </div>
</div>

<!-- Модальное окно добавления члена команды -->
<div class="modal fade" id="addTeamMemberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Добавить участника команды</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="/dashboard/company/team/add">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Имя и фамилия *</label>
            <input type="text" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Должность *</label>
            <input type="text" name="role" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">LinkedIn</label>
            <input type="url" name="linkedin" class="form-control" placeholder="https://linkedin.com/in/...">
          </div>
          <div class="mb-3">
            <label class="form-label">Telegram</label>
            <input type="text" name="telegram" class="form-control" placeholder="@username или номер">
          </div>
          <div class="mb-3">
            <label class="form-label">Instagram</label>
            <input type="text" name="instagram" class="form-control" placeholder="@username">
          </div>
          <div class="mb-3">
            <label class="form-label">Веб-сайт</label>
            <input type="url" name="website" class="form-control" placeholder="https://...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Добавить</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно редактирования члена команды -->
<div class="modal fade" id="editTeamMemberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Редактировать члена команды</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="/dashboard/company/team/edit" id="editTeamMemberForm">
        <input type="hidden" name="person_id" id="edit_person_id">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Имя и фамилия *</label>
            <input type="text" name="name" id="edit_person_name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Должность *</label>
            <input type="text" name="role" id="edit_person_role" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">LinkedIn</label>
            <input type="url" name="linkedin" id="edit_person_linkedin" class="form-control" placeholder="https://linkedin.com/in/...">
          </div>
          <div class="mb-3">
            <label class="form-label">Telegram</label>
            <input type="text" name="telegram" id="edit_person_telegram" class="form-control" placeholder="@username или номер">
          </div>
          <div class="mb-3">
            <label class="form-label">Instagram</label>
            <input type="text" name="instagram" id="edit_person_instagram" class="form-control" placeholder="@username">
          </div>
          <div class="mb-3">
            <label class="form-label">Веб-сайт</label>
            <input type="url" name="website" id="edit_person_website" class="form-control" placeholder="https://...">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить изменения</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно добавления питча -->
<div class="modal fade" id="addPitchModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Добавить питч</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="/dashboard/company/pitch/add">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Название питча *</label>
            <input type="text" name="title" class="form-control" required>
          </div>
          <div class="mb-3">
            <label class="form-label">Ссылка на питч *</label>
            <input type="url" name="url" class="form-control" placeholder="https://..." required>
            <small class="text-muted">Ссылка на презентацию (Google Slides, PowerPoint Online, PDF и т.д.)</small>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Добавить</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Модальное окно редактирования профиля -->
<div class="modal fade" id="editProfileModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Редактировать профиль</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form method="post" action="/dashboard/user/edit" id="editProfileForm">
        <div class="modal-body">
          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Имя</label>
              <input type="text" class="form-control" name="first_name" value="{{ user.first_name }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Фамилия</label>
              <input type="text" class="form-control" name="last_name" value="{{ user.last_name }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Страна</label>
              <select name="country_id" class="form-select" required>
                <option value="">Выберите страну</option>
                {% for country in countries %}
                  <option value="{{ country.id }}" {% if country.id == user.country_id %}selected{% endif %}>
                    {{ country.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Город</label>
              <input type="text" class="form-control" name="city" value="{{ user.city }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Телефон</label>
              <input type="tel" class="form-control" name="phone" value="{{ user.phone }}" required>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Telegram</label>
              <input type="text" class="form-control" name="telegram" value="{{ user.telegram or '' }}" placeholder="@username или username">
              <small class="form-text text-muted">Введите только никнейм (например: @username или username)</small>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">LinkedIn</label>
              <input type="text" class="form-control" name="linkedin" value="{{ user.linkedin or '' }}" placeholder="username">
              <small class="form-text text-muted">Введите только никнейм (например: username)</small>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          <button type="submit" class="btn btn-primary">Сохранить</button>
        </div>
      </form>
    </div>
  </div>
</div>

        <!-- Модальное окно создания компании -->
        <div class="modal fade" id="createPageModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Создать компанию</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="text-center">
                  <i class="bi bi-building text-primary fs-1 mb-4"></i>
                  <h5 class="mb-3">Создать страницу компании</h5>
                  <p class="text-muted mb-4">Создайте страницу для вашего стартапа или компании, чтобы привлечь инвесторов и партнеров</p>
                  <a href="/dashboard/create-company" class="btn btn-primary btn-lg px-4 py-2">Создать компанию</a>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Модальное окно создания инвестора -->
        {% if not user.company_id %}
        <div class="modal fade" id="createInvestorModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Создать инвестора</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <div class="text-center">
                  <i class="bi bi-graph-up text-success fs-1 mb-4"></i>
                  <h5 class="mb-3">Создать инвестиционный профиль</h5>
                  <p class="text-muted mb-4">Создайте профиль инвестора, чтобы находить интересные стартапы для инвестиций</p>
                  <a href="/dashboard/create-investor" class="btn btn-success btn-lg px-4 py-2">Создать инвестора</a>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% endif %}

        <script>
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', function() {
          // Показываем toast уведомления при загрузке страницы
          showToasts();
          
          // Инициализация основных вкладок ЛК
          initializeMainTabs();
          
          // Дополнительная проверка для вкладки edit-company
          setTimeout(() => {
            const editCompanyPane = document.getElementById('edit-company');
            if (editCompanyPane && editCompanyPane.classList.contains('active')) {
              initializeCompanyEditTabs();
            }
          }, 200);

          // Если есть success параметр, обновляем данные на странице
          const urlParams = new URLSearchParams(window.location.search);
          const success = urlParams.get('success');
          if (success === 'profile_updated') {
            // Обновляем данные на странице без перезагрузки
            updateProfileData();
          }
        });
        
        // Функция для инициализации основных вкладок ЛК
        function initializeMainTabs() {
          const navLinks = document.querySelectorAll('.dashboard-sidebar .nav-link');
          const tabPanes = document.querySelectorAll('.tab-pane');
          
          // Функция для активации вкладки
          function activateTab(tabId) {
            // Убираем активный класс у всех ссылок и вкладок
            navLinks.forEach(l => l.classList.remove('active'));
            
            // Скрываем все панели вкладок
            tabPanes.forEach(pane => {
              pane.classList.remove('show', 'active');
              pane.style.display = 'none';
            });
            
            // Активируем нужную ссылку
            const targetLink = document.querySelector(`[href="#${tabId}"]`);
            if (targetLink) {
              targetLink.classList.add('active');
            }
            
            // Активируем нужную вкладку
            const targetPane = document.querySelector(`#${tabId}`);
            if (targetPane) {
              targetPane.classList.add('show', 'active');
              targetPane.style.display = 'block';
            }
            
            // Если активируем edit-company, инициализируем подвкладки
            if (tabId === 'edit-company') {
              setTimeout(() => {
                initializeCompanyEditTabs();
              }, 150);
            }
          }
          
          // Активируем вкладку из URL параметра или по умолчанию
          const urlParams = new URLSearchParams(window.location.search);
          const activeTab = urlParams.get('tab') || 'profile';
          activateTab(activeTab);
          
          // Добавляем обработчики кликов
          navLinks.forEach(link => {
            link.addEventListener('click', function(e) {
              e.preventDefault();
              
              const target = this.getAttribute('href').substring(1);
              activateTab(target);
            });
          });
        }
        
        // Функция для инициализации вкладок редактирования компании
        function initializeCompanyEditTabs() {
          const editCompanyTabs = document.querySelectorAll('#editCompanyTabs .nav-link');
          const editCompanyTabContent = document.querySelectorAll('#edit-company .tab-pane');
          
          // Сначала скрываем все вкладки
          editCompanyTabs.forEach(tab => {
            tab.classList.remove('active');
            tab.setAttribute('aria-selected', 'false');
          });
          editCompanyTabContent.forEach(content => {
            content.classList.remove('show', 'active');
            content.style.display = 'none';
          });
          
          // Альтернативная функция для активации вкладки (более простая)
          function activateEditTabSimple(tabId) {
            // Убираем активный класс у всех вкладок
            editCompanyTabs.forEach(tab => {
              tab.classList.remove('active');
              tab.setAttribute('aria-selected', 'false');
            });
            
            // Скрываем ВСЕ панели вкладок
            editCompanyTabContent.forEach(content => {
              content.classList.remove('show', 'active');
              content.style.display = 'none';
            });
            
            // Активируем нужную вкладку
            const targetTab = document.querySelector(`[data-bs-target="#${tabId}"]`);
            const targetContent = document.getElementById(tabId);
            
            if (targetTab && targetContent) {
              targetTab.classList.add('active');
              targetTab.setAttribute('aria-selected', 'true');
              targetContent.classList.add('show', 'active');
              targetContent.style.display = 'block';
            }
          }
          
          // Функция для активации вкладки
          function activateEditTab(tabId) {
            // Убираем активный класс у всех вкладок
            editCompanyTabs.forEach(tab => {
              tab.classList.remove('active');
              tab.setAttribute('aria-selected', 'false');
            });
            
            // Скрываем все панели вкладок - более агрессивно
            editCompanyTabContent.forEach(content => {
              content.classList.remove('show', 'active');
              content.style.display = 'none';
              content.style.visibility = 'hidden';
              content.style.opacity = '0';
              content.style.position = 'static';
            });
            
            // Активируем нужную вкладку
            const targetTab = document.querySelector(`[data-bs-target="#${tabId}"]`);
            const targetContent = document.getElementById(tabId);
            
            if (targetTab && targetContent) {
              targetTab.classList.add('active');
              targetTab.setAttribute('aria-selected', 'true');
              targetContent.classList.add('show', 'active');
              targetContent.style.display = 'block';
              targetContent.style.visibility = 'visible';
              targetContent.style.opacity = '1';
              targetContent.style.position = 'static';
            }
          }
          
          // Добавляем обработчики кликов
          editCompanyTabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
              e.preventDefault();
              
              const targetId = this.getAttribute('data-bs-target').substring(1);
              
              // Используем простую функцию
              activateEditTabSimple(targetId);
            });
          });
          
          // Активируем первую вкладку по умолчанию
          if (editCompanyTabs.length > 0 && editCompanyTabContent.length > 0) {
            const firstTabId = editCompanyTabs[0].getAttribute('data-bs-target').substring(1);
            activateEditTabSimple(firstTabId);
          }
          
          // Проверяем параметр subtab в URL
          const urlParams = new URLSearchParams(window.location.search);
          const subtab = urlParams.get('subtab');
          if (subtab) {
            // Активируем нужную подвкладку
            activateEditTabSimple(subtab);
          }
        }

        // Функция для переключения на вкладку (используется в кнопках)
        function switchToTab(tabId) {
          // Находим ссылку и симулируем клик
          const targetLink = document.querySelector(`[href="#${tabId}"]`);
          if (targetLink) {
            targetLink.click();
          }
        }

        // Функция для показа toast уведомлений
        function showToasts() {
          // Показываем error toast
          const errorToast = document.getElementById('errorToast');
          if (errorToast) {
            const toast = new bootstrap.Toast(errorToast, {
              delay: 5000, // 5 секунд
              autohide: true
            });
            toast.show();
          }

          // Показываем success toast
          const successToast = document.getElementById('successToast');
          if (successToast) {
            const toast = new bootstrap.Toast(successToast, {
              delay: 4000, // 4 секунды
              autohide: true
            });
            toast.show();
          }
        }

        // Функция для создания и показа toast уведомления
        function showToast(message, type = 'success') {
          const toastContainer = document.querySelector('.toast-container');
          
          const toastHtml = `
            <div class="toast align-items-center text-white bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">
                  <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                  ${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
          `;
          
          toastContainer.insertAdjacentHTML('beforeend', toastHtml);
          
          const toastElement = toastContainer.lastElementChild;
          const toast = new bootstrap.Toast(toastElement, {
            delay: type === 'success' ? 4000 : 5000,
            autohide: true
          });
          
          toast.show();
          
          // Удаляем элемент после скрытия
          toastElement.addEventListener('hidden.bs.toast', function() {
            toastElement.remove();
          });
        }

        // Функции для управления командой
        function editTeamMember(id, name, role, linkedin, telegram, instagram, website) {
          // Заполняем форму редактирования
          document.getElementById('edit_person_id').value = id;
          document.getElementById('edit_person_name').value = name;
          document.getElementById('edit_person_role').value = role;
          document.getElementById('edit_person_linkedin').value = linkedin;
          document.getElementById('edit_person_telegram').value = telegram;
          document.getElementById('edit_person_instagram').value = instagram;
          document.getElementById('edit_person_website').value = website;
          
          // Открываем модальное окно
          const modal = new bootstrap.Modal(document.getElementById('editTeamMemberModal'));
          modal.show();
        }

        function deleteTeamMember(id, name) {
          if (confirm(`Вы уверены, что хотите удалить участника команды "${name}"?`)) {
            // Создаем форму для удаления
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/dashboard/company/team/delete/${id}`;
            document.body.appendChild(form);
            form.submit();
          }
        }

        function editPitch(id) {
          // TODO: Реализовать редактирование питча
          alert('Редактирование питча будет добавлено позже');
        }

        function deletePitch(id) {
          if (confirm('Вы уверены, что хотите удалить этот питч?')) {
            // Создаем форму для удаления
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `/dashboard/company/pitch/delete/${id}`;
            document.body.appendChild(form);
            form.submit();
          }
        }

        // Функция для обновления данных профиля на странице
        function updateProfileData() {
          // Получаем данные из формы редактирования
          const form = document.getElementById('editProfileForm');
          const formData = new FormData(form);
          
          // Обновляем отображаемые данные
          const firstName = formData.get('first_name');
          const lastName = formData.get('last_name');
          const city = formData.get('city');
          const phone = formData.get('phone');
          const telegram = formData.get('telegram');
          const linkedin = formData.get('linkedin');
          const countrySelect = formData.get('country_id');
          
          // Обновляем элементы на странице
          const nameElements = document.querySelectorAll('.profile-section .col-md-6:nth-child(1) p');
          if (nameElements.length > 0) {
            nameElements[0].textContent = firstName;
          }
          
          const lastNameElements = document.querySelectorAll('.profile-section .col-md-6:nth-child(2) p');
          if (lastNameElements.length > 0) {
            lastNameElements[0].textContent = lastName;
          }
          
          const cityElements = document.querySelectorAll('.profile-section .col-md-6:nth-child(5) p');
          if (cityElements.length > 0) {
            cityElements[0].textContent = city;
          }
          
          const phoneElements = document.querySelectorAll('.profile-section .col-md-6:nth-child(4) p');
          if (phoneElements.length > 0) {
            phoneElements[0].textContent = phone;
          }
          
          const telegramElements = document.querySelectorAll('.profile-section .col-md-6:nth-child(6) p');
          if (telegramElements.length > 0) {
            if (telegram) {
              let telegramLink = '';
              let telegramText = '';
              if (telegram.startsWith('http')) {
                telegramLink = telegram;
                telegramText = telegram.split('/').pop() || telegram.split('@').pop() || telegram;
              } else if (telegram.startsWith('@')) {
                telegramLink = `https://t.me/${telegram.substring(1)}`;
                telegramText = telegram;
              } else {
                telegramLink = `https://t.me/${telegram}`;
                telegramText = `@${telegram}`;
              }
              telegramElements[0].innerHTML = `<a href="${telegramLink}" target="_blank" class="text-decoration-none"><i class="bi bi-telegram text-primary me-1"></i>${telegramText}</a>`;
            } else {
              telegramElements[0].textContent = 'Не указан';
            }
          }
          
          const linkedinElements = document.querySelectorAll('.profile-section .col-12:nth-child(7) p');
          if (linkedinElements.length > 0) {
            if (linkedin) {
              let linkedinLink = '';
              let linkedinText = '';
              if (linkedin.startsWith('http')) {
                linkedinLink = linkedin;
                linkedinText = linkedin.split('/').pop() || linkedin.split('in/').pop() || linkedin;
              } else {
                linkedinLink = `https://linkedin.com/in/${linkedin}`;
                linkedinText = linkedin;
              }
              linkedinElements[0].innerHTML = `<a href="${linkedinLink}" target="_blank" class="text-decoration-none"><i class="bi bi-linkedin text-primary me-1"></i>${linkedinText}</a>`;
            } else {
              linkedinElements[0].textContent = 'Не указан';
            }
          }
          
          // Обновляем страну в статистике
          const countrySelectElement = document.querySelector('select[name="country_id"]');
          if (countrySelectElement && countrySelect) {
            const selectedOption = countrySelectElement.querySelector(`option[value="${countrySelect}"]`);
            if (selectedOption) {
              const countryStatsElement = document.querySelector('.stats-card:nth-child(3) .fw-bold');
              if (countryStatsElement) {
                countryStatsElement.textContent = selectedOption.textContent;
              }
            }
          }
        }
        </script>
{% endblock %} 